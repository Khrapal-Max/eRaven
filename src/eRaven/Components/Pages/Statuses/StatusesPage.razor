@page "/status-transitions"

@using eRaven.Domain.Models
@using eRaven.Components.Pages.Statuses.Modals
@using eRaven.Application.ViewModels.PersonStatusViewModels

<PageTitle>Зміна статусів</PageTitle>

<div class="container-fluid py-2 d-flex flex-column" style="gap:.5rem; min-height:70vh;">

    <!-- Toolbar -->
    <div class="d-flex align-items-center gap-2 p-1 flex-wrap justify-content-between w-100">
        <!-- Пошук (ліворуч) -->
        <div class="flex-grow-1" style="min-width:260px; max-width:600px;">
            <SearchBox @bind-Value="Search"
                       Delay="350"
                       Placeholder="Пошук: ПІБ / РНОКПП"
                       Disabled="@Busy"
                       OnSearch="OnSearchAsync" />
        </div>

        <!-- Кнопки праворуч -->
        <div class="d-flex align-items-center gap-2">
            <!-- Перемикач режиму -->
            <button class="btn btn-sm @(OneShotMode ? "btn-primary" : "btn-warning")"
                    title="Одиничний: після зміни статусу очищаємо пошук. Пакетний: залишаємо результати."
                    disabled="@Busy"
                    @onclick="ToggleOneShotMode">
                <i class="bi @(OneShotMode ? "bi-1-circle" : "bi-stack")"></i>
                @(OneShotMode ? "Режим: одиничний" : "Режим: пакетний")
            </button>

            <!-- Імпорт статусів -->
            <ExcelImport TItem="PersonStatusImportView"
                         StopOnParseErrors="true"
                         MaxSizeMb="5"
                         OnBusyChanged="OnImportBusyChanged"
                         ProcessAsync="ProcessImportedStatusesAsync"
                         OnCompleted="OnImportCompleted" />
        </div>
    </div>

    <!-- Таблиця -->
    @if (Filtered.Count > 0)
    {
        <div class="bg-dark rounded flex-grow-1 d-flex">
            <TableBaseComponent Items="Filtered"
                                TItem="Person"
                                Class="table align-middle mb-0">
                <TableHeader>
                    <th class="text-black">ПІБ</th>
                    <th class="text-black text-center">Звання</th>
                    <th class="text-black text-center">РНОКПП</th>
                    <th class="text-black text-center">Позивний</th>
                    <th class="text-black">Посада</th>
                    <th class="text-black text-center">Поточний статус</th>
                    <th class="text-black"></th>
                </TableHeader>

                <RowTemplate Context="p">
                    <td>@p.FullName</td>
                    <td class="text-center">@p.Rank</td>
                    <td class="text-center">@p.Rnokpp</td>
                    <td class="text-center">@p.Callsign</td>
                    <td>@p.PositionUnit?.ShortName</td>
                    <td class="text-center">@(p.StatusKind?.Name ?? "")</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-warning"
                                title="Змінити статус"
                                disabled="@Busy"
                                @onclick="() => OpenSetStatus(p)">
                            <i class="bi bi-sliders"></i> Змінити статус
                        </button>
                    </td>
                </RowTemplate>
            </TableBaseComponent>
        </div>
    }
    else
    {
        <div class="h5 px-2">@((Busy ? "Завантаження…" : "Список порожній або нічого не знайдено."))</div>
    }
</div>

@* Модальне вікно зміни статусу *@
<StatusSetModal Open="@_isStatusModalOpen"
                Busy="@Busy"
                PersonCard="@_modalPerson"
                CurrentStatus="@_modalCurrentStatus"
                AllowedNextStatuses="@_mapStatuses"
                OnSubmit="HandleStatusSubmitAsync"
                OnClose="HandleStatusCloseAsync" />

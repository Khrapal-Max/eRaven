@* @using eRaven.Application.ViewModels.PersonStatusViewModels
@using eRaven.Domain.Models

@if (Open)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" aria-modal="true" role="dialog" @key="PersonCard?.Id">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Header -->
                <div class="modal-header py-2 text-white">
                    <h6 class="modal-title">Встановлення статусу</h6>
                    <button type="button"
                            class="btn-close btn-close-white"
                            aria-label="Close"
                            @onclick="OnCancelClick"
                            @onclick:preventDefault="true"
                            @onclick:stopPropagation="true" />
                </div>

                <!-- Body -->
                <EditForm EditContext="_editCtx" OnValidSubmit="HandleValidSubmitAsync">
                    <DataAnnotationsValidator />
                    <AntiforgeryToken />

                    <div class="modal-body">
                        <div class="row g-3">

                            <!-- LEFT: Інформація про особу -->
                            <div class="col-md-6">
                                @if (PersonCard is not null)
                                {
                                    <div class="card h-100 text-body border-0 shadow-sm">
                                        <div class="card-body p-3">
                                            <!-- ПІБ -->
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <div class="fs-5 fw-semibold">
                                                    @PersonCard.FullName
                                                </div>
                                                @if (!string.IsNullOrWhiteSpace(PersonCard.Callsign))
                                                {
                                                    <span class="badge text-bg-warning text-dark">Позивний: @PersonCard.Callsign</span>
                                                }
                                            </div>

                                            <!-- Звання / РНОКПП -->
                                            <div class="d-flex flex-wrap gap-2 mb-2 justify-content-between">
                                                @if (!string.IsNullOrWhiteSpace(PersonCard.Rank))
                                                {
                                                    <span class="badge text-bg-light border fw-semibold text-dark">
                                                        Звання: @PersonCard.Rank
                                                    </span>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(PersonCard.Rnokpp))
                                                {
                                                    <span class="badge text-bg-secondary">РНОКПП: @PersonCard.Rnokpp</span>
                                                }
                                            </div>

                                            <!-- Підрозділ -->
                                            <div class="mb-3">
                                                <div class="text-muted small mb-1">Підрозділ</div>
                                                <div class="fw-medium">@PersonCard.PositionUnit?.ShortName</div>
                                            </div>

                                            <!-- Поточний статус -->
                                            @if (CurrentStatus is not null)
                                            {
                                                <hr class="my-2" />
                                                <div class="text-muted small mb-1">Поточний статус</div>

                                                <div class="fs-6 fw-semibold mb-1">
                                                    @{
                                                        var sk = CurrentStatus.StatusKind;
                                                        var label = sk is null
                                                            ? $"ID {CurrentStatus.StatusKindId}"
                                                            : $"{(string.IsNullOrWhiteSpace(sk.Code) ? "" : sk.Code + " ")}{(string.IsNullOrWhiteSpace(sk.Name) ? "" : $"({sk.Name})")}";
                                                    }
                                                    @label
                                                </div>

                                                <div class="text-muted small">
                                                    з @CurrentStatus.OpenDate.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                                                </div>
                                            }
                                        </div> <!-- /.card-body -->
                                    </div>     <!-- /.card -->
                                }
                            </div> <!-- /.col-md-6 -->

                            <!-- RIGHT: Вибір -->
                            <div class="col-md-6">
                                <div class="card h-100 text-body border-0 shadow-sm">
                                    <div class="card-body p-3">

                                        <!-- Новий статус -->
                                        <div class="mb-3">
                                            <label class="form-label">Новий статус</label>

                                            <InputSelect TValue="int"
                                                         class="form-select"
                                                         Value="_vm.StatusId"
                                                         ValueChanged="OnStatusChanged"
                                                         ValueExpression="() => _vm.StatusId"
                                                         disabled="@(!(AllowedNextStatuses?.Any() ?? false) || Busy)">
                                                <option value="0">— Оберіть статус —</option>
                                                @if (AllowedNextStatuses is not null && AllowedNextStatuses.Count > 0)
                                                {
                                                    @foreach (var status in AllowedNextStatuses
                                                                            .OrderBy(s => s.Code ?? string.Empty, StringComparer.OrdinalIgnoreCase)
                                                                            .ThenBy(s => s.Name ?? string.Empty, StringComparer.OrdinalIgnoreCase))
                                                    {
                                                        <option value="@status.Id">@GetStatusLabel(status)</option>
                                                    }
                                                }
                                            </InputSelect>
                                            <ValidationMessage For="@(() => _vm.StatusId)" />
                                        </div>

                                        <!-- Дата встановлення -->
                                        <div class="mb-3">
                                            <label class="form-label">Дата встановлення</label>
                                            <InputDate TValue="DateTime?" @bind-Value="DateLocal" class="form-control" />
                                            <div class="form-text">
                                                Статус набуде чинності з <strong>00:00</strong> обраного дня (локальний час).
                                            </div>
                                            <ValidationMessage For="@(() => _vm.Moment)" />
                                        </div>

                                        <!-- Нотатка -->
                                        <div class="mb-2">
                                            <label class="form-label">Нотатка (необов’язково)</label>
                                            <InputTextArea class="form-control" @bind-Value="_vm.Note" rows="3" disabled="@Busy" />
                                        </div>

                                    </div> <!-- /.card-body -->
                                </div>     <!-- /.card -->
                            </div>         <!-- /.col-md-6 -->

                        </div> <!-- /.row -->
                    </div>     <!-- /.modal-body -->

                    <!-- Footer -->
                    <div class="modal-footer py-2" style="border-top-color: var(--ng-bg, #492448);">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                @onclick="OnCancelClick"
                                @onclick:preventDefault="true"
                                @onclick:stopPropagation="true">
                            Скасувати
                        </button>
                        <button type="submit"
                                class="btn"
                                style="background: var(--ng-bg, #492448); color:#fff;"
                                disabled="@(Busy || !CanSubmit)">
                            Підтвердити
                        </button>
                    </div>
                </EditForm>
            </div> <!-- /.modal-content -->
        </div>     <!-- /.modal-dialog -->
    </div>         <!-- /.modal -->

    <div class="modal-backdrop fade show"></div>
}
 *@
@page "/position-assignments"

@using eRaven.Application.ViewModels.PositionAssignmentViewModels
@using eRaven.Components.Pages.PositionAssignments.Modals
@using eRaven.Components.Shared.ExcelExportButton
@using eRaven.Domain.Models
@using eRaven.Domain.Person

<PageTitle>Призначення на посаду</PageTitle>

<div class="container-fluid py-2 d-flex flex-column" style="gap:.5rem; min-height:70vh;">
    <!-- Toolbar -->
    <div class="d-flex align-items-center gap-2 p-1 flex-wrap justify-content-between w-100">
        <div class="flex-grow-1" style="min-width:250px; max-width:600px;">
            <SearchBox @bind-Value="Search"
                       Delay="300"
                       Placeholder="Пошук: ПІБ / ІПН / позивний"
                       OnSearch="OnSearchAsync" />
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
            <ExcelExportButton TItem="PersonAssignmentExportRow"
                               Items="_exportItems"
                               FileName="Призначення_на_посаду"
                               Text="Експорт"
                               Title="Експорт видимого списку у Excel"
                               OnBusyChanged="OnBusyChanged" />
        </div>
    </div>

    <!-- Persons -->
    @if (_filtered.Count > 0)
    {
        <div class="bg-dark rounded flex-grow-1 d-flex">
            <TableBaseComponent Items="_filtered"
                                TItem="Person"
                                Class="table align-middle mb-0"
                                MinHeight="70vh"
                                MaxHeight="75vh"
                                SelectedItem="SelectedPerson"
                                SelectedItemChanged="(it => SelectedPerson = it)"
                                OnClick="OnPersonClick">
                <TableHeader>
                    <th class="text-black">ПІБ</th>
                    <th class="text-black text-center">Звання</th>
                    <th class="text-black text-center">РНОКПП</th>
                    <th class="text-black">Поточна посада</th>
                    <th class="text-black text-center" style="width:220px;">Дії</th>
                </TableHeader>

                <RowTemplate Context="p">
                    <td>@p.FullName</td>
                    <td class="text-center">@p.Rank</td>
                    <td class="text-center">@p.Rnokpp</td>
                    <td>@p.PositionUnit?.FullName</td>
                    <td class="text-center">
                        @if (SelectedPerson?.Id == p.Id)
                        {
                            <button class="btn btn-primary"
                                    title="@((_freePositions?.Count ?? 0) == 0 ? "Немає вільних посад" : "Призначити на посаду")"
                                    disabled="@((_freePositions?.Count ?? 0) == 0)"
                                    @onclick:stopPropagation="true"
                                    @onclick="OpenAssignModal">
                                <i class="bi bi-person-plus"></i>
                            </button>
                        }
                    </td>
                </RowTemplate>
            </TableBaseComponent>
        </div>
    }
    else
    {
        <div class="text-muted">Нічого не знайдено.</div>
    }
</div>

<AssignPositionModal @ref="_assignModal"
                     Positions="_freePositions"
                     OnAssigned="HandleAssigned" />

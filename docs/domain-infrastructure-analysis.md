# Аналіз узгодженості доменної моделі та інфраструктури

## 1. Огляд
Доменна модель eRaven зосереджена навколо агрегату `Person`, який керує подіями, історією статусів, призначеннями на посади та плановими діями. Інфраструктурний шар побудовано на EF Core й описує відповідні сутності через `AppDbContext` та конфігурації `IEntityTypeConfiguration`. Нижче наведено зіставлення ключових частин моделі та їхнього відображення в БД, а також спостережені розбіжності й ризики.

## 2. Відповідність сутностей
### Person ↔ persons
* Домен підтримує агрегат із внутрішніми колекціями та подіями, включно з поточною посадою, статусом, плановими діями й аудитом часових міток.【F:src/eRaven/Domain/Models/Person.cs†L16-L621】
* Конфігурація EF віддзеркалює ключові властивості (`rnokpp`, `rank`, ПІБ, `bzvp`, `weapon`, `callsign`), встановлює довжини рядків, унікальні індекси та звʼязки до `PositionUnit`, `StatusKind`, історій статусів/призначень/дій. Обчислювані властивості та колекції оголошено як `Ignore`, щоб запобігти дублюванню стану.【F:src/eRaven/Infrastructure/Configurations/PersonConfiguration.cs†L14-L162】
* Значення `CreatedUtc`/`ModifiedUtc` мають дефолт у БД, але домен встановлює їх через події створення/модифікації. Це узгоджено, якщо вставка виконується після відпрацювання подій; інакше можливий дрейф між значеннями домену й дефолтами БД.

### PersonStatus ↔ person_statuses
* Доменна модель зберігає снапшот статусу з посиланням на людину, обчислює `IsActive`, послідовність та дозволяє оновлення нотаток/закриття статусу.【F:src/eRaven/Domain/Models/PersonStatus.cs†L13-L118】
* Інфраструктура накладає обмеження на часові поля, довжини, дефолти для `sequence`, `is_active`, `author`, `modified` та індекси для пошуку, що відповідає доменним інваріантам про активний запис і порядок подій.【F:src/eRaven/Infrastructure/Configurations/PersonStatusConfiguration.cs†L15-L93】
* Домен очікує суворе керування послідовністю та унікальність активних статусів через логіку агрегату, а конфігурація додає унікальний індекс для `PersonId/OpenDate/Sequence` лише для активних рядків, що підсилює інваріант.

### PersonPositionAssignment ↔ person_position_assignments
* Доменна модель надає знімок призначення з логікою закриття/оновлення та обчислюваною ознакою `IsActive`.【F:src/eRaven/Domain/Models/PersonPositionAssignment.cs†L13-L76】
* Конфігурація EF робить `IsActive` ігнорованим і забезпечує обмеження на часові інтервали та унікальність активних призначень на людину й посаду, що узгоджується з доменними правилами про єдине активне призначення.【F:src/eRaven/Infrastructure/Configurations/PersonPositionAssignmentConfiguration.cs†L15-L107】

### PlanAction ↔ plan_actions
* Домен зберігає снапшот планових дій разом із повними даними про людину на момент планування та використовує події для синхронізації з агрегатом `Person`.【F:src/eRaven/Domain/Models/PlanAction.cs†L15-L138】【F:src/eRaven/Domain/Models/Person.cs†L244-L366】
* Інфраструктура відображає всі поля снапшоту, задає обовʼязковість та довжини для рядків, перетворює перерахування в короткий цілий і встановлює індекси для пошуку за датою та типом переміщення, що відповідає сценаріям звітності. Звʼязок з `Person` налаштовано як 1↔N із каскадом.【F:src/eRaven/Infrastructure/Configurations/PlanActionConfiguration.cs†L16-L115】

### PositionUnit, StatusKind, StatusTransition
* Супутні довідники мають прості доменні моделі з мінімальними властивостями.【F:src/eRaven/Domain/Models/PositionUnit.cs†L13-L37】【F:src/eRaven/Domain/Models/StatusKind.cs†L13-L45】【F:src/eRaven/Domain/Models/StatusTransition.cs†L13-L27】
* Конфігурації накладають обмеження довжин, дефолти, індекси та перевірки цілісності (наприклад, `from <> to` для переходів), що посилює доменні припущення про унікальність кодів і валідність переходів.【F:src/eRaven/Infrastructure/Configurations/PositionUnitConfiguration.cs†L16-L77】【F:src/eRaven/Infrastructure/Configurations/StatusKindConfiguration.cs†L16-L81】【F:src/eRaven/Infrastructure/Configurations/StatusTransitionConfiguration.cs†L16-L67】

## 3. Узгодженість подій та контексту
* `AppDbContext` експонує всі доменні агрегати та снапшоти як `DbSet`, а також автоматично підтягує всі конфігурації, що знижує ризик пропустити нову сутність на інфраструктурному рівні.【F:src/eRaven/Infrastructure/AppDbContext.cs†L13-L31】
* Агрегат `Person` генерує доменні події (`PersonCreatedEvent`, `PlanActionAddedEvent` тощо) та накопичує їх у `PendingEvents`, але інфраструктура поки що лише ігнорує це поле; механізму опублікування подій або обробки outbox у наданому коді немає. Це вимагає додаткового сервісу для передавання подій у зовнішні системи.

## 4. Виявлені прогалини та потенційні ризики
1. **Дефолти БД vs доменні значення.** Для кількох полів (`CreatedUtc`, `ModifiedUtc`, `Author`) конфігурація покладається на дефолти СУБД. Якщо домен заповнює ці значення вручну, варто переконатися, що EF не ігнорує їх на вставці/оновленні; інакше можливі розбіжності між історією подій та фактичними даними в БД.【F:src/eRaven/Domain/Models/Person.cs†L471-L585】【F:src/eRaven/Infrastructure/Configurations/PersonConfiguration.cs†L79-L88】
2. **Обмеження довжин.** Деякі обмеження (наприклад, `BZVP` 50 символів у `Person`, 128 у `PlanAction`) можуть призвести до усічення при формуванні снапшотів, якщо домен не валідує довжину перед створенням події. Варто синхронізувати максимально допустимі значення або додати доменну валідацію для уникнення помилок збереження.【F:src/eRaven/Domain/Models/Person.cs†L50-L58】【F:src/eRaven/Infrastructure/Configurations/PersonConfiguration.cs†L52-L55】【F:src/eRaven/Infrastructure/Configurations/PlanActionConfiguration.cs†L89-L104】
3. **Керування подіями.** Відсутність інфраструктурного обробника `PendingEvents` може ускладнити інтеграцію з іншими bounded context або забезпечення eventual consistency. Рекомендується впровадити механізм публікації (наприклад, outbox-патерн) під час `SaveChanges`.
4. **Повторне відтворення агрегату.** Метод `BuildFromHistory` очікує повну історію подій у правильному порядку й викидає виняток, якщо трапляються події іншого агрегата. Інфраструктура наразі не містить репозиторію, що гарантує це, отже під час реалізації слід подбати про сортування за `OccurredAtUtc` і фільтрацію за `PersonId` до передачі у домен.【F:src/eRaven/Domain/Models/Person.cs†L414-L468】

## 5. Рекомендації
* Вирівняти обмеження довжин між доменом і конфігурацією або додати доменну валідацію перед генерацією подій.
* Перевірити, чи EF не перезаписує встановлені доменом часові поля дефолтами БД; у разі потреби вимкнути дефолти або налаштувати `ValueGeneratedNever`.
* Реалізувати інфраструктурний сервіс, що витягує `PendingEvents` з агрегата після `SaveChanges` і публікує їх (outbox, message bus тощо).
* Створити репозиторій або фабрику агрегата `Person`, що гарантує правильне завантаження історії подій для `BuildFromHistory`, якщо застосунок покладається на event-sourcing-сценарії.
